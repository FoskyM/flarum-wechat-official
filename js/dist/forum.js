(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{extend:()=>f});const e=flarum.core.compat["common/extenders"];var n=t.n(e);function a(t,o){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},a(t,o)}function r(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,a(t,o)}const i=flarum.core.compat["common/Model"];var c=t.n(i),s=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).user_id=c().attribute("user_id"),o.wechat_open_id=c().attribute("wechat_open_id"),o.wechat_original_data=c().hasOne("wechat_original_data"),o}return r(o,t),o}(c()),u=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).openid=c().attribute("openid"),o.nickname=c().attribute("nickname"),o.sex=c().attribute("sex"),o.language=c().attribute("language"),o.city=c().attribute("city"),o.province=c().attribute("province"),o.country=c().attribute("country"),o.headimgurl=c().attribute("headimgurl"),o.privilege=c().attribute("privilege"),o}return r(o,t),o}(c());const f=[(new(n().Store)).add("wechat_link",s).add("wechat_original_data",u)],l=flarum.core.compat["forum/app"];var d=t.n(l);const h=flarum.core.compat["common/extend"],p=flarum.core.compat["forum/components/NotificationGrid"];var w=t.n(p);const y=flarum.core.compat["forum/components/SettingsPage"];var b=t.n(y);flarum.core.compat["common/components/Alert"];const g=flarum.core.compat["common/components/Button"];var _=t.n(g);const k=flarum.core.compat["common/components/LinkButton"];var v=t.n(k);flarum.core.compat["common/components/Link"],flarum.core.compat["common/components/Page"];const x=flarum.core.compat["common/helpers/icon"];var L=t.n(x);const q=flarum.core.compat["common/models/User"];var A=t.n(q);const C=flarum.core.compat["forum/components/LogInButtons"];var M=t.n(C);const O=flarum.core.compat["forum/components/LogInModal"];var I=t.n(O);const N=flarum.core.compat["forum/components/EditUserModal"];var W=t.n(N);const B=flarum.core.compat["forum/components/Notification"];var S=t.n(B);flarum.core.compat["common/helpers/username"];var T=function(t){function o(){return t.apply(this,arguments)||this}r(o,t);var e=o.prototype;return e.icon=function(){return"fab fa-weixin"},e.href=function(){return"/settings"},e.content=function(){return(this.attrs.notification.content()||{}).is_unlinked?d().translator.trans("foskym-wechat-official.forum.notifications.wechat_unlinked"):d().translator.trans("foskym-wechat-official.forum.notifications.wechat_linked")},o}(S());const U=flarum.core.compat["common/components/Modal"];var P=t.n(U);const j=flarum.core.compat["common/utils/ItemList"];var E=t.n(j);const F=flarum.core.compat["common/components/LoadingIndicator"];var G=t.n(F),z=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).qrCodeUrl=null,o.qrCodeId=0,o.qrCodeType="bind",o}r(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.qrCodeType=this.attrs.type||"bind",this.loading=!0,d().request({method:"GET",url:d().forum.attribute("apiUrl")+"/wechat-official/qrcode"}).then((function(t){e.qrCodeUrl=t.url,e.qrCodeId=t.id,e.loading=!1,setInterval(e.checkScanStatus.bind(e),5e3),m.redraw()}))},e.className=function(){return"Modal--small"},e.title=function(){return d().translator.trans("foskym-wechat-official.forum.scan."+this.qrCodeType+".title")},e.fields=function(){var t=new(E());return t.add("qrcode",m("div",{className:"Form-group"},this.loading?m(G(),null):m("img",{src:this.qrCodeUrl,alt:"QR Code",style:"width: 100%"}))),t},e.body=function(){return[m("div",{className:"Form Form--centered"},this.fields().toArray())]},e.footer=function(){return d().translator.trans("foskym-wechat-official.forum.scan."+this.qrCodeType+".description")},e.content=function(){return[m("div",{className:"Modal-body"},this.body()),m("div",{className:"Modal-footer"},this.footer())]},e.onsubmit=function(t){t.preventDefault()},e.checkScanStatus=function(){d().request({method:"GET",url:d().forum.attribute("apiUrl")+"/wechat-official/qrcode/"+this.qrCodeId,body:{}}).then((function(t){"scaned"===t.status&&(d().modal.close(),window.location.reload())}))},o}(P());function D(){var t=d().forum.attribute("foskym-wechat-official.app_id"),o=d().forum.attribute("baseUrl")+"/wechat-official/callback";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+t+"&redirect_uri="+encodeURIComponent(o)+"&response_type=code&scope=snsapi_userinfo&state=wechat#wechat_redirect"}function R(){return/MicroMessenger/i.test(navigator.userAgent)}function Q(){return/wechat_redirect=true/.test(location.href)}d().initializers.add("foskym/flarum-wechat-official",(function(){A().prototype.WechatAuth=c().attribute("WechatAuth"),d().notificationComponents.wechatLinked=T,(0,h.extend)(w().prototype,"notificationTypes",(function(t){t.add("wechatLinked",{name:"wechatLinked",icon:"fab fa-weixin",label:d().translator.trans("foskym-wechat-official.forum.settings.notify_wechat_linked_label")})})),(0,h.extend)(w().prototype,"notificationMethods",(function(t){d().forum.attribute("foskym-wechat-official.enable_push")&&t.add("push",{name:"push",icon:"fab fa-weixin",label:d().translator.trans("foskym-wechat-official.forum.settings.push_notification_label")})})),(0,h.extend)(M().prototype,"items",(function(t){t.add("wechat-official-login",m(_(),{onclick:function(){return d().modal.show(z,{type:"login"})},className:"Button Button--block LogInButton--wechat-official"},L()("fab fa-weixin")," ",d().translator.trans("foskym-wechat-official.forum.login-button")))})),(0,h.extend)(W().prototype,"fields",(function(t){this.attrs.user,this.attrs.user.canEditCredentials()&&this.attrs.user.WechatAuth().wechat_open_id&&t.add("wechat-official-openid",m("div",{className:"Form-group"},m("label",null,"公众号 Openid"),m("input",{className:"FormControl",placeholder:"公众号 Openid",readonly:!0,value:this.attrs.user.WechatAuth().wechat_open_id})))})),(0,h.extend)(b().prototype,"accountItems",(function(t){var o=this,e=D();t.add("wechat",this.user.WechatAuth().isLinked&&d().forum.attribute("foskym-wechat-official.enable_unbind")?m(_(),{icon:"fab fa-weixin",className:"Button Button--Wechat",onclick:function(){d().request({method:"POST",url:d().forum.attribute("apiUrl")+"/wechat-official/unlink"}).then((function(){o.user.WechatAuth().isLinked=!1,d().alerts.show({type:"success"},d().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink_success")),m.redraw()}))}},d().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink")):R()?m(v(),{icon:"fab fa-weixin",className:"Button Button--Wechat",disabled:this.user.WechatAuth().isLinked,href:e,external:!0},this.user.WechatAuth().isLinked?d().translator.trans("foskym-wechat-official.forum.settings.wechat_linked"):d().translator.trans("foskym-wechat-official.forum.settings.bind_wechat")):m(_(),{icon:"fab fa-weixin",className:"Button Button--Wechat",disabled:this.user.WechatAuth().isLinked,onclick:function(){d().modal.show(z,{type:"bind"})}},this.user.WechatAuth().isLinked?d().translator.trans("foskym-wechat-official.forum.settings.wechat_linked"):d().translator.trans("foskym-wechat-official.forum.settings.bind_wechat")),-100)})),(0,h.extend)(I().prototype,"oncreate",(function(){if(R()&&!Q()&&d().forum.attribute("foskym-wechat-official.enable_login_replace")){var t=D();window.location.href=t}else $(".LogInModal").show()})),document.addEventListener("DOMContentLoaded",(function(){R()&&Q()&&(d().session.user?m.route.set("/settings"):setTimeout((function(){d().modal.show(I()),$(".LogInModal").show()}),200))}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map