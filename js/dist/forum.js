(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{extend:()=>h});const e=flarum.core.compat["common/extend"],n=flarum.core.compat["common/components/EditUserModal"];var a=t.n(n);const r=flarum.core.compat["common/extenders"];var i=t.n(r);function c(t,o){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},c(t,o)}function s(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,c(t,o)}const u=flarum.core.compat["common/Model"];var l=t.n(u),f=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).user_id=l().attribute("user_id"),o.wechat_open_id=l().attribute("wechat_open_id"),o.wechat_original_data=l().hasOne("wechat_original_data"),o}return s(o,t),o}(l()),d=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).openid=l().attribute("openid"),o.nickname=l().attribute("nickname"),o.sex=l().attribute("sex"),o.language=l().attribute("language"),o.city=l().attribute("city"),o.province=l().attribute("province"),o.country=l().attribute("country"),o.headimgurl=l().attribute("headimgurl"),o.privilege=l().attribute("privilege"),o}return s(o,t),o}(l());const h=[(new(i().Store)).add("wechat_link",f).add("wechat_original_data",d)],p=flarum.core.compat["common/models/User"];t.n(p)().prototype.WechatAuth=l().attribute("WechatAuth"),(0,e.extend)(a().prototype,"fields",(function(t){this.attrs.user,this.attrs.user.canEditCredentials()&&this.attrs.user.WechatAuth().wechat_open_id&&t.add("wechat-official-openid",m("div",{className:"Form-group"},m("label",null,"公众号 Openid"),m("input",{className:"FormControl",placeholder:"公众号 Openid",readonly:!0,value:this.attrs.user.WechatAuth().wechat_open_id})))}));const w=flarum.core.compat["forum/app"];var y=t.n(w);const b=flarum.core.compat["forum/components/NotificationGrid"];var g=t.n(b);const _=flarum.core.compat["forum/components/SettingsPage"];var k=t.n(_);flarum.core.compat["common/components/Alert"];const v=flarum.core.compat["common/components/Button"];var x=t.n(v);const L=flarum.core.compat["common/components/LinkButton"];var q=t.n(L);flarum.core.compat["common/components/Link"],flarum.core.compat["common/components/Page"];const A=flarum.core.compat["common/helpers/icon"];var C=t.n(A);const M=flarum.core.compat["forum/components/LogInButtons"];var O=t.n(M);const I=flarum.core.compat["forum/components/LogInModal"];var N=t.n(I);const W=flarum.core.compat["forum/components/Notification"];var B=t.n(W);flarum.core.compat["common/helpers/username"];var S=function(t){function o(){return t.apply(this,arguments)||this}s(o,t);var e=o.prototype;return e.icon=function(){return"fab fa-weixin"},e.href=function(){return"/settings"},e.content=function(){return(this.attrs.notification.content()||{}).is_unlinked?y().translator.trans("foskym-wechat-official.forum.notifications.wechat_unlinked"):y().translator.trans("foskym-wechat-official.forum.notifications.wechat_linked")},o}(B());const T=flarum.core.compat["common/components/Modal"];var U=t.n(T);const P=flarum.core.compat["common/utils/ItemList"];var j=t.n(P);const E=flarum.core.compat["common/components/LoadingIndicator"];var F=t.n(E),G=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).qrCodeUrl=null,o.qrCodeId=0,o.qrCodeType="bind",o}s(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.qrCodeType=this.attrs.type||"bind",this.loading=!0,y().request({method:"GET",url:y().forum.attribute("apiUrl")+"/wechat-official/qrcode"}).then((function(t){e.qrCodeUrl=t.url,e.qrCodeId=t.id,e.loading=!1,setInterval(e.checkScanStatus.bind(e),5e3),m.redraw()}))},e.className=function(){return"Modal--small"},e.title=function(){return y().translator.trans("foskym-wechat-official.forum.scan."+this.qrCodeType+".title")},e.fields=function(){var t=new(j());return t.add("qrcode",m("div",{className:"Form-group"},this.loading?m(F(),null):m("img",{src:this.qrCodeUrl,alt:"QR Code",style:"width: 100%"}))),t},e.body=function(){return[m("div",{className:"Form Form--centered"},this.fields().toArray())]},e.footer=function(){return y().translator.trans("foskym-wechat-official.forum.scan."+this.qrCodeType+".description")},e.content=function(){return[m("div",{className:"Modal-body"},this.body()),m("div",{className:"Modal-footer"},this.footer())]},e.onsubmit=function(t){t.preventDefault()},e.checkScanStatus=function(){y().request({method:"GET",url:y().forum.attribute("apiUrl")+"/wechat-official/qrcode/"+this.qrCodeId,body:{}}).then((function(t){"scaned"===t.status&&(y().modal.close(),window.location.reload())}))},o}(U());function z(){var t=y().forum.attribute("foskym-wechat-official.app_id"),o=y().forum.attribute("baseUrl")+"/wechat-official/callback";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+t+"&redirect_uri="+encodeURIComponent(o)+"&response_type=code&scope=snsapi_userinfo&state=wechat#wechat_redirect"}function D(){return/MicroMessenger/i.test(navigator.userAgent)}function R(){return/wechat_redirect=true/.test(location.href)}y().initializers.add("foskym/flarum-wechat-official",(function(){y().notificationComponents.wechatLinked=S,(0,e.extend)(g().prototype,"notificationTypes",(function(t){t.add("wechatLinked",{name:"wechatLinked",icon:"fab fa-weixin",label:y().translator.trans("foskym-wechat-official.forum.settings.notify_wechat_linked_label")})})),(0,e.extend)(g().prototype,"notificationMethods",(function(t){y().forum.attribute("foskym-wechat-official.enable_push")&&t.add("push",{name:"push",icon:"fab fa-weixin",label:y().translator.trans("foskym-wechat-official.forum.settings.push_notification_label")})})),(0,e.extend)(O().prototype,"items",(function(t){t.add("wechat-official-login",m(x(),{onclick:function(){return y().modal.show(G,{type:"login"})},className:"Button Button--block LogInButton--wechat-official"},C()("fab fa-weixin")," ",y().translator.trans("foskym-wechat-official.forum.login-button")))})),(0,e.extend)(k().prototype,"accountItems",(function(t){var o=this,e=z();t.add("wechat",this.user.WechatAuth().isLinked&&y().forum.attribute("foskym-wechat-official.enable_unbind")?m(x(),{icon:"fab fa-weixin",className:"Button Button--Wechat",onclick:function(){y().request({method:"POST",url:y().forum.attribute("apiUrl")+"/wechat-official/unlink"}).then((function(){o.user.WechatAuth().isLinked=!1,y().alerts.show({type:"success"},y().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink_success")),m.redraw()}))}},y().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink")):D()?m(q(),{icon:"fab fa-weixin",className:"Button Button--Wechat",disabled:this.user.WechatAuth().isLinked,href:e,external:!0},this.user.WechatAuth().isLinked?y().translator.trans("foskym-wechat-official.forum.settings.wechat_linked"):y().translator.trans("foskym-wechat-official.forum.settings.bind_wechat")):m(x(),{icon:"fab fa-weixin",className:"Button Button--Wechat",disabled:this.user.WechatAuth().isLinked,onclick:function(){y().modal.show(G,{type:"bind"})}},this.user.WechatAuth().isLinked?y().translator.trans("foskym-wechat-official.forum.settings.wechat_linked"):y().translator.trans("foskym-wechat-official.forum.settings.bind_wechat")),-100)})),(0,e.extend)(N().prototype,"oncreate",(function(){if(D()&&!R()&&y().forum.attribute("foskym-wechat-official.enable_login_replace")){var t=z();window.location.href=t}else $(".LogInModal").show()})),document.addEventListener("DOMContentLoaded",(function(){D()&&R()&&(y().session.user?m.route.set("/settings"):setTimeout((function(){y().modal.show(N()),$(".LogInModal").show()}),200))}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map