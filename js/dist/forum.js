(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{extend:()=>f});const o=flarum.core.compat["common/extenders"];var n=t.n(o);function a(t,e){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},a(t,e)}function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,a(t,e)}const i=flarum.core.compat["common/Model"];var c=t.n(i),s=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),a=0;a<o;a++)n[a]=arguments[a];return(e=t.call.apply(t,[this].concat(n))||this).user_id=c().attribute("user_id"),e.wechat_open_id=c().attribute("wechat_open_id"),e.wechat_original_data=c().hasOne("wechat_original_data"),e}return r(e,t),e}(c()),u=function(t){function e(){for(var e,o=arguments.length,n=new Array(o),a=0;a<o;a++)n[a]=arguments[a];return(e=t.call.apply(t,[this].concat(n))||this).openid=c().attribute("openid"),e.nickname=c().attribute("nickname"),e.sex=c().attribute("sex"),e.language=c().attribute("language"),e.city=c().attribute("city"),e.province=c().attribute("province"),e.country=c().attribute("country"),e.headimgurl=c().attribute("headimgurl"),e.privilege=c().attribute("privilege"),e}return r(e,t),e}(c());const f=[(new(n().Store)).add("wechat_link",s).add("wechat_original_data",u)],l=flarum.core.compat["forum/app"];var p=t.n(l);const h=flarum.core.compat["common/extend"],d=flarum.core.compat["forum/components/NotificationGrid"];var w=t.n(d);const b=flarum.core.compat["forum/components/SettingsPage"];var y=t.n(b);flarum.core.compat["common/components/Alert"];const _=flarum.core.compat["common/components/Button"];var g=t.n(_);const k=flarum.core.compat["common/components/LinkButton"];var v=t.n(k);flarum.core.compat["common/components/Link"],flarum.core.compat["common/components/Page"],flarum.core.compat["common/helpers/icon"];const x=flarum.core.compat["common/models/User"];var L=t.n(x);const O=flarum.core.compat["forum/components/LogInModal"];var M=t.n(O);const A=flarum.core.compat["forum/components/Notification"];var P=t.n(A);flarum.core.compat["common/helpers/username"];var S=function(t){function e(){return t.apply(this,arguments)||this}r(e,t);var o=e.prototype;return o.icon=function(){return"fab fa-weixin"},o.href=function(){return"/settings"},o.content=function(){return(this.attrs.notification.content()||{}).is_unlinked?p().translator.trans("foskym-wechat-official.forum.notifications.wechat_unlinked"):p().translator.trans("foskym-wechat-official.forum.notifications.wechat_linked")},e}(P());function W(){var t=p().forum.attribute("foskym-wechat-official.app_id"),e=p().forum.attribute("baseUrl")+"/wechat-official/callback";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+t+"&redirect_uri="+encodeURIComponent(e)+"&response_type=code&scope=snsapi_userinfo&state=wechat#wechat_redirect"}function j(){return/MicroMessenger/i.test(navigator.userAgent)}function B(){return/wechat_redirect=true/.test(location.href)}p().initializers.add("foskym/flarum-wechat-official",(function(){L().prototype.WechatAuth=c().attribute("WechatAuth"),p().notificationComponents.wechatLinked=S,(0,h.extend)(w().prototype,"notificationTypes",(function(t){t.add("wechatLinked",{name:"wechatLinked",icon:"fab fa-weixin",label:p().translator.trans("foskym-wechat-official.forum.settings.notify_wechat_linked_label")})})),(0,h.extend)(w().prototype,"notificationMethods",(function(t){p().forum.attribute("foskym-wechat-official.enable_push")&&t.add("push",{name:"push",icon:"fab fa-weixin",label:p().translator.trans("foskym-wechat-official.forum.settings.push_notification_label")})})),(0,h.extend)(y().prototype,"accountItems",(function(t){var e=this,o=W();t.add("wechat",this.user.WechatAuth().isLinked&&p().forum.attribute("foskym-wechat-official.enable_unbind")?m(g(),{icon:"fab fa-weixin",className:"Button Button--Wechat",onclick:function(){p().request({method:"POST",url:p().forum.attribute("apiUrl")+"/wechat-official/unlink"}).then((function(){e.user.WechatAuth().isLinked=!1,p().alerts.show({type:"success"},p().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink_success")),m.redraw()}))}},p().translator.trans("foskym-wechat-official.forum.settings.wechat_unlink")):m(v(),{icon:"fab fa-weixin",className:"Button Button--Wechat",disabled:this.user.WechatAuth().isLinked,href:o,external:!0},this.user.WechatAuth().isLinked?p().translator.trans("foskym-wechat-official.forum.settings.wechat_linked"):p().translator.trans("foskym-wechat-official.forum.settings.bind_wechat")),-100)})),(0,h.extend)(M().prototype,"oncreate",(function(){if(j()&&!B()&&p().forum.attribute("foskym-wechat-official.enable_login_replace")){var t=W();window.location.href=t}else $(".LogInModal").show()})),document.addEventListener("DOMContentLoaded",(function(){j()&&B()&&(p().session.user?m.route.set("/settings"):setTimeout((function(){p().modal.show(M()),$(".LogInModal").show()}),200))}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map